# HAProxy configuration for OpenClaw Gateway
# Provides TLS termination, rate limiting, IP allowlisting, and WebSocket support
#
# Usage:
#   1. Generate TLS certificate (see below)
#   2. Edit the "allowed_ips" ACL with your trusted networks
#   3. Test:  haproxy -f haproxy.cfg -c
#   4. Start: haproxy -f haproxy.cfg
#
# TLS certificate (self-signed):
#   openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem \
#     -days 365 -nodes -subj "/CN=openclaw.local"
#   cat cert.pem key.pem > /etc/haproxy/certs/openclaw.pem
#
# TLS certificate (Let's Encrypt):
#   certbot certonly --standalone -d openclaw.example.com
#   cat /etc/letsencrypt/live/openclaw.example.com/fullchain.pem \
#       /etc/letsencrypt/live/openclaw.example.com/privkey.pem \
#       > /etc/haproxy/certs/openclaw.pem

# ── Global ───────────────────────────────────────────────────────────

global
    maxconn 4096
    log stdout format raw local0 info

    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

# ── Defaults ─────────────────────────────────────────────────────────

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull

    timeout connect  5s
    timeout client  60s
    timeout server  60s
    timeout tunnel   1h      # long-lived WebSocket connections

# ── Frontend: HTTPS + redirect ───────────────────────────────────────

frontend ft_openclaw
    bind *:80
    bind *:443 ssl crt /etc/haproxy/certs/openclaw.pem alpn h2,http/1.1

    # Redirect HTTP to HTTPS
    http-request redirect scheme https code 301 unless { ssl_fc }

    # ── Rate limiting (100 requests per 10s per IP) ──────────────────
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # ── IP allowlist ─────────────────────────────────────────────────
    # Edit these to match your trusted networks, or use a file:
    #   acl allowed_ips src -f /etc/haproxy/allowlist.txt
    acl allowed_ips src 127.0.0.1 ::1 192.168.0.0/16 10.0.0.0/8 172.16.0.0/12
    http-request deny deny_status 403 unless allowed_ips

    # ── Security headers ─────────────────────────────────────────────
    http-response set-header Strict-Transport-Security   "max-age=31536000; includeSubDomains" if { ssl_fc }
    http-response set-header X-Content-Type-Options      "nosniff"
    http-response set-header X-Frame-Options             "SAMEORIGIN"
    http-response set-header X-XSS-Protection            "1; mode=block"
    http-response set-header Referrer-Policy              "strict-origin-when-cross-origin"

    default_backend bk_openclaw

# ── Backend: OpenClaw Gateway ────────────────────────────────────────

backend bk_openclaw
    balance roundrobin

    # Forward real client info to OpenClaw
    http-request set-header X-Real-IP           %[src]
    http-request set-header X-Forwarded-For     %[src]
    http-request set-header X-Forwarded-Proto   https if { ssl_fc }
    http-request set-header X-Forwarded-Proto   http  if !{ ssl_fc }
    http-request set-header X-Forwarded-Host    %[req.hdr(Host)]

    # Server definition — adjust IP if gateway runs on another host
    server openclaw 127.0.0.1:18789 check inter 5s rise 2 fall 3

# ── Stats (optional, remove in production or change credentials) ─────

frontend ft_stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats auth admin:changeme
    no log
